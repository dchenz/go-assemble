<!DOCTYPE html>

<html>
  <head>
    <title>Example</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
  </head>

  <body>
    <div class="container">
      <div class="row" style="margin-top: 30px; margin-bottom: 30px">
        <div class="col">
          <h1>Example</h1>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <input id="file-input" type="file" onchange="onFileSelect()" />
        </div>
        <div class="col">
          <div id="file-result" class="alert alert-info">
            Try uploading a very big file and view requests in the developer
            panel.
          </div>
        </div>
      </div>
    </div>
    <script>
      async function onFileSelect() {
        const f = document.getElementById("file-input");
        const file = f.files[0];
        if (file) {
          const fileID = Date.now(); // Use a more reliable ID generator
          const chunkSize = 2 ** 24; // 16MB
          const totalChunks = Math.ceil(file.size / chunkSize);
          for (let i = 0; i < totalChunks; i++) {
            const chunkBlob = file.slice(i * chunkSize, (i + 1) * chunkSize);
            fetch("http://localhost:5000/api/upload", {
              method: "POST",
              headers: {
                // Other headers can go here too, such as Authorization.
                "x-assemble-file-id": fileID,
                "x-assemble-chunk-sequence": i,
                "x-assemble-chunk-total": totalChunks,
                "x-assemble-content-type": file.type,
              },
              body: chunkBlob,
            })
              .then((resp) => resp.json())
              .then((resp) => {
                const resultDisplay = document.getElementById("file-result");
                if (resp.error) {
                  resultDisplay.innerText = resp.error;
                  resultDisplay.className = "alert alert-warning";
                } else if (resp.have === resp.want) {
                  resultDisplay.innerText = `Successfully uploaded file with ID ${fileID}`;
                  resultDisplay.className = "alert alert-success";
                } else {
                  // Not guaranteed to be in ascending order.
                  resultDisplay.innerText = `Progress: ${resp.have}/${resp.want}`;
                }
              })
              .catch(console.error);
          }
        }
      }
    </script>
  </body>
</html>
